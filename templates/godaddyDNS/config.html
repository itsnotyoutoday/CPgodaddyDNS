{% load i18n %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h4>{% trans "GoDaddy DNS Configuration" %}</h4>
            </div>
            <div class="card-body">
                <div id="godaddy-config-form">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="form-group">
                                <label for="api_key">{% trans "GoDaddy API Key" %}</label>
                                <input type="text" class="form-control" id="api_key" 
                                       value="{% if config %}{{ config.api_key }}{% endif %}"
                                       placeholder="Enter your GoDaddy API Key">
                                <small class="form-text text-muted">
                                    Get your API key from <a href="https://developer.godaddy.com/keys" target="_blank">GoDaddy Developer Portal</a>
                                </small>
                            </div>

                            <div class="form-group">
                                <label for="api_secret">{% trans "GoDaddy API Secret" %}</label>
                                <input type="password" class="form-control" id="api_secret" 
                                       value="{% if config %}{{ config.api_secret }}{% endif %}"
                                       placeholder="Enter your GoDaddy API Secret">
                            </div>

                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="use_production" 
                                           {% if config.use_production %}checked{% endif %}>
                                    <label class="form-check-label" for="use_production">
                                        {% trans "Use Production API" %}
                                    </label>
                                    <small class="form-text text-muted">
                                        Uncheck for testing with OTE (development) environment
                                    </small>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="sync_enabled" 
                                           {% if sync_enabled %}checked{% endif %}>
                                    <label class="form-check-label" for="sync_enabled">
                                        {% trans "Enable Automatic Sync" %}
                                    </label>
                                    <small class="form-text text-muted">
                                        Automatically sync DNS changes between CyberPanel and GoDaddy
                                    </small>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="conflict_strategy">{% trans "Conflict Resolution Strategy" %}</label>
                                <select class="form-control" id="conflict_strategy">
                                    <option value="godaddy_wins" {% if config.conflict_strategy == 'godaddy_wins' %}selected{% endif %}>
                                        GoDaddy Takes Precedence
                                    </option>
                                    <option value="manual" {% if config.conflict_strategy == 'manual' %}selected{% endif %}>
                                        Queue for Manual Review
                                    </option>
                                    <option value="timestamp" {% if config.conflict_strategy == 'timestamp' %}selected{% endif %}>
                                        Use Modification Timestamps
                                    </option>
                                </select>
                            </div>

                            <div class="form-group">
                                <button type="button" class="btn btn-primary" onclick="saveGoDaddyConfig()">
                                    <i class="fa fa-save"></i> {% trans "Save Configuration" %}
                                </button>
                                {% if has_config %}
                                <button type="button" class="btn btn-secondary ml-2" onclick="testGoDaddyConnection()">
                                    <i class="fa fa-plug"></i> {% trans "Test Connection" %}
                                </button>
                                {% endif %}
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h5>{% trans "Quick Start Guide" %}</h5>
                                    <ol class="small">
                                        <li>Get your GoDaddy API key and secret from the <a href="https://developer.godaddy.com/keys" target="_blank">Developer Portal</a></li>
                                        <li>Enter your credentials above</li>
                                        <li>Test the connection</li>
                                        <li>Enable automatic sync</li>
                                        <li>Discover your domains</li>
                                    </ol>

                                    {% if has_config %}
                                    <div class="mt-3">
                                        <h6>{% trans "Status" %}</h6>
                                        <p class="mb-1">
                                            <span class="badge badge-{% if is_active %}success{% else %}secondary{% endif %}">
                                                {% if is_active %}Active{% else %}Inactive{% endif %}
                                            </span>
                                        </p>
                                        <p class="mb-1">
                                            <small class="text-muted">
                                                Last updated: {{ config.updated_at|date:"M d, Y H:i" }}
                                            </small>
                                        </p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading overlay -->
                <div id="godaddy-loading" class="text-center" style="display: none;">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Saving configuration...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function saveGoDaddyConfig() {
    const configData = {
        api_key: document.getElementById('api_key').value.trim(),
        api_secret: document.getElementById('api_secret').value.trim(),
        use_production: document.getElementById('use_production').checked,
        sync_enabled: document.getElementById('sync_enabled').checked,
        conflict_strategy: document.getElementById('conflict_strategy').value
    };

    if (!configData.api_key || !configData.api_secret) {
        swal("Error", "Please enter both API Key and Secret", "error");
        return;
    }

    // Show loading
    document.getElementById('godaddy-config-form').style.display = 'none';
    document.getElementById('godaddy-loading').style.display = 'block';

    fetch('/godaddy/save-config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(configData)
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('godaddy-config-form').style.display = 'block';
        document.getElementById('godaddy-loading').style.display = 'none';

        if (data.success) {
            swal("Success", data.message, "success").then(() => {
                location.reload();
            });
        } else {
            swal("Error", data.error, "error");
        }
    })
    .catch(error => {
        document.getElementById('godaddy-config-form').style.display = 'block';
        document.getElementById('godaddy-loading').style.display = 'none';
        swal("Error", "An error occurred while saving configuration", "error");
        console.error('Error:', error);
    });
}

function testGoDaddyConnection() {
    // This would call a test endpoint
    swal("Info", "Connection test functionality coming soon", "info");
}

// CSRF token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>